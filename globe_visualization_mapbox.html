<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IFRC Field Reports Globe Visualization</title>
    <script src='https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.css' rel='stylesheet' />
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            overflow: hidden;
        }

        #map {
            width: 100vw;
            height: 100vh;
        }

        #controls {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.75);
            color: white;
            padding: 10px;
            border-radius: 6px;
            z-index: 100;
            min-width: 140px;
            max-width: 160px;
        }

        #controls h3 {
            margin: 0 0 8px 0;
            font-size: 12px;
        }

        #timeline-container {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.75);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            z-index: 100;
            min-width: 600px;
            max-width: 70vw;
        }

        #timeline-bar {
            width: 100%;
            height: 30px;
            position: relative;
            margin: 8px 0;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
            cursor: pointer;
        }

        #timeline-progress {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #2196F3);
            width: 0%;
            transition: width 0.1s linear;
            pointer-events: none;
        }

        #timeline-years {
            display: flex;
            justify-content: space-between;
            margin-top: 6px;
            font-size: 10px;
            color: #ccc;
        }

        #timeline-current {
            text-align: center;
            font-size: 15px;
            font-weight: bold;
            margin-bottom: 6px;
            color: #4CAF50;
        }

        #timeline-controls {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
        }

        #timeline-controls button {
            width: auto;
            padding: 6px 16px;
            font-size: 12px;
        }

        #speed-control {
            display: flex;
            align-items: center;
            gap: 6px;
            background: rgba(255, 255, 255, 0.1);
            padding: 5px 10px;
            border-radius: 4px;
        }

        #speed-control label {
            font-size: 11px;
            white-space: nowrap;
        }

        #zoom-controls {
            position: absolute;
            top: 10px;
            right: 180px;
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        #zoom-controls button {
            width: 35px;
            height: 35px;
            background: rgba(0, 0, 0, 0.75);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #zoom-controls button:hover {
            background: rgba(0, 0, 0, 0.9);
        }

        #stats {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.75);
            color: white;
            padding: 10px;
            border-radius: 6px;
            z-index: 100;
            min-width: 140px;
            max-width: 160px;
        }

        .stat-item {
            margin: 6px 0;
            font-size: 11px;
        }

        .stat-number {
            font-size: 18px;
            font-weight: bold;
            color: #4CAF50;
        }

        .event-label {
            position: absolute;
            background: rgba(255, 0, 0, 0.9);
            color: white;
            padding: 8px 15px;
            border-radius: 5px;
            font-size: 16px;
            font-weight: bold;
            z-index: 50;
            pointer-events: none;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.8; }
            50% { opacity: 1; }
        }

        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px 0;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            width: 100%;
        }

        button:hover {
            background: #45a049;
        }

        button:disabled {
            background: #666;
            cursor: not-allowed;
        }

        input[type="range"] {
            width: 100%;
            margin: 10px 0;
        }

        .legend {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #444;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin: 6px 0;
            font-size: 11px;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .mapboxgl-popup-content {
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 10px;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <div id="map"></div>

    <div id="controls">
        <h3>Event Types</h3>
        <div class="legend-item">
            <div class="legend-color" style="background: #ff4444;"></div>
            <span>COVID-19</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #ff8800;"></div>
            <span>Ukraine Conflict</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #4444ff;"></div>
            <span>Other Disasters</span>
        </div>
    </div>

    <div id="zoom-controls">
        <button id="zoomIn" title="Zoom In">+</button>
        <button id="zoomOut" title="Zoom Out">−</button>
    </div>

    <div id="timeline-container">
        <div id="timeline-current">Loading...</div>
        <div id="timeline-bar">
            <div id="timeline-progress"></div>
        </div>
        <div id="timeline-years">
            <span>2019</span>
            <span>2020</span>
            <span>2021</span>
            <span>2022</span>
            <span>2023</span>
        </div>
        <div id="timeline-controls">
            <button id="playPause">▶ Play</button>
            <button id="restart">⟲ Restart</button>
            <div id="speed-control">
                <label>Speed: <span id="speedLabel">1x</span></label>
                <input type="range" id="speedSlider" min="1" max="10" value="1" style="width: 150px; margin: 0;">
            </div>
        </div>
    </div>

    <div id="stats">
        <div class="stat-item">
            <div>Total Reports</div>
            <div class="stat-number" id="totalReports">0</div>
        </div>
        <div class="stat-item">
            <div>COVID-19</div>
            <div class="stat-number" id="covidCount" style="color: #ff4444;">0</div>
        </div>
        <div class="stat-item">
            <div>Ukraine Conflict</div>
            <div class="stat-number" id="ukraineCount" style="color: #ff8800;">0</div>
        </div>
        <div class="stat-item">
            <div>Other Events</div>
            <div class="stat-number" id="otherCount" style="color: #4444ff;">0</div>
        </div>
    </div>

    <script>
        mapboxgl.accessToken = 'pk.eyJ1IjoiZ28taWZyYyIsImEiOiJjbWYwdXhyaXIxYTk3MnJzNzliM3B4cHozIn0.lu7cqSPDHP4Mm2i00PcBQw';

        // Initialize Mapbox map with globe projection
        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/go-ifrc/ckrfe16ru4c8718phmckdfjh0',
            projection: 'globe',
            center: [78, 20], // India/Asia centered
            zoom: 1.5,
            pitch: 0
        });

        let allReports = [];
        let currentIndex = 0;
        let visiblePoints = [];
        let isPlaying = false;
        let animationInterval = null;
        let speed = 1;
        let eventLabels = {
            covid: null,
            ukraine: null
        };
        let markersMap = new Map();
        let activeRings = [];

        // Event colors
        const eventColors = {
            'COVID-19': '#ff4444',
            'Ukraine Conflict': '#ff8800',
            'default': '#4444ff'
        };

        // Configure fog and atmosphere for globe
        map.on('style.load', () => {
            map.setFog({
                'range': [0.8, 8],
                'color': '#ffffff',
                'horizon-blend': 0.1,
                'high-color': '#245bde',
                'space-color': '#000000',
                'star-intensity': 0.15
            });

            // Add custom tileset as a source
            map.addSource('go-countries', {
                'type': 'vector',
                'url': 'mapbox://go-ifrc.go-countries'
            });

            // Add source for animated rings
            map.addSource('rings', {
                'type': 'geojson',
                'data': {
                    'type': 'FeatureCollection',
                    'features': []
                }
            });

            // Add layer for animated rings - they will sync with the globe
            map.addLayer({
                'id': 'ring-layer',
                'type': 'circle',
                'source': 'rings',
                'paint': {
                    'circle-radius': [
                        'interpolate',
                        ['linear'],
                        ['get', 'progress'],
                        0, 5,
                        1, 25
                    ],
                    'circle-color': ['get', 'color'],
                    'circle-opacity': [
                        'interpolate',
                        ['linear'],
                        ['get', 'progress'],
                        0, 0.8,
                        1, 0
                    ],
                    'circle-stroke-width': 2,
                    'circle-stroke-color': ['get', 'color'],
                    'circle-stroke-opacity': [
                        'interpolate',
                        ['linear'],
                        ['get', 'progress'],
                        0, 1,
                        1, 0
                    ]
                }
            });
        });

        // Auto-rotate the globe (east to west)
        let userInteracting = false;
        let rotationInterval = null;
        let userLng = 78; // Start at India

        function spinGlobe() {
            // Only auto-rotate when playing AND not interacting
            if (!userInteracting && isPlaying) {
                // Get current center and update longitude
                const center = map.getCenter();
                userLng = center.lng - 0.15; // Continue from current position
                if (userLng < -180) userLng += 360;
                if (userLng > 180) userLng -= 360;
                
                map.setCenter([userLng, center.lat]);
            }
        }

        map.on('load', () => {
            rotationInterval = setInterval(spinGlobe, 30);
        });

        // Track user interaction - but allow interaction during playback
        map.on('mousedown', () => {
            userInteracting = true;
        });

        map.on('mouseup', () => {
            // Update userLng to current position before resuming rotation
            const center = map.getCenter();
            userLng = center.lng;
            
            // Small delay before resuming auto-rotation
            setTimeout(() => {
                userInteracting = false;
            }, 1000);
        });

        map.on('dragend', () => {
            // Update userLng to current position before resuming rotation
            const center = map.getCenter();
            userLng = center.lng;
            
            setTimeout(() => {
                userInteracting = false;
            }, 1000);
        });

        map.on('touchstart', () => {
            userInteracting = true;
        });

        map.on('touchend', () => {
            // Update userLng to current position before resuming rotation
            const center = map.getCenter();
            userLng = center.lng;
            
            setTimeout(() => {
                userInteracting = false;
            }, 1000);
        });

        map.on('wheel', () => {
            userInteracting = true;
            setTimeout(() => {
                userInteracting = false;
            }, 1000);
        });

        function getPointColor(event) {
            return eventColors[event] || eventColors['default'];
        }

        function createMarker(report, showRing = true) {
            const el = document.createElement('div');
            el.className = 'marker';
            el.style.width = '10px';
            el.style.height = '10px';
            el.style.borderRadius = '50%';
            el.style.backgroundColor = getPointColor(report.event);
            el.style.border = '2px solid white';
            el.style.boxShadow = '0 0 10px rgba(0,0,0,0.5)';
            el.style.cursor = 'pointer';
            
            // Add pulsing animation
            el.style.animation = 'pulse-marker 2s ease-in-out infinite';

            const marker = new mapboxgl.Marker(el)
                .setLngLat([report.lng, report.lat])
                .setPopup(new mapboxgl.Popup({ offset: 25 })
                    .setHTML(`
                        <div>
                            <b>${report.title}</b><br/>
                            Date: ${report.date}<br/>
                            Event: ${report.event}
                        </div>
                    `))
                .addTo(map);

            // Only create expanding ring animation during playback
            if (showRing) {
                createRingAnimation(report);
            }

            return marker;
        }

        function createRingAnimation(report) {
            // Create a ring feature
            const ring = {
                type: 'Feature',
                geometry: {
                    type: 'Point',
                    coordinates: [report.lng, report.lat]
                },
                properties: {
                    color: getPointColor(report.event),
                    progress: 0,
                    startTime: Date.now()
                }
            };

            activeRings.push(ring);
            updateRings();

            // Animate the ring
            const duration = 1500; // 1.5 seconds
            const startTime = Date.now();
            
            function animateRing() {
                const elapsed = Date.now() - startTime;
                const progress = Math.min(elapsed / duration, 1);
                
                ring.properties.progress = progress;
                updateRings();
                
                if (progress < 1) {
                    requestAnimationFrame(animateRing);
                } else {
                    // Remove the ring after animation completes
                    const index = activeRings.indexOf(ring);
                    if (index > -1) {
                        activeRings.splice(index, 1);
                        updateRings();
                    }
                }
            }
            
            requestAnimationFrame(animateRing);
        }

        function updateRings() {
            const source = map.getSource('rings');
            if (source) {
                source.setData({
                    type: 'FeatureCollection',
                    features: activeRings
                });
            }
        }

        // Add CSS animation for pulsing markers
        const style = document.createElement('style');
        style.textContent = `
            @keyframes pulse-marker {
                0%, 100% { 
                    transform: scale(1);
                    opacity: 0.8;
                }
                50% { 
                    transform: scale(1.2);
                    opacity: 1;
                }
            }
        `;
        document.head.appendChild(style);

        function updateStats() {
            const covid = visiblePoints.filter(p => p.event === 'COVID-19').length;
            const ukraine = visiblePoints.filter(p => p.event === 'Ukraine Conflict').length;
            const other = visiblePoints.length - covid - ukraine;

            document.getElementById('totalReports').textContent = visiblePoints.length;
            document.getElementById('covidCount').textContent = covid;
            document.getElementById('ukraineCount').textContent = ukraine;
            document.getElementById('otherCount').textContent = other;
        }

        function updateTimeline() {
            if (currentIndex < allReports.length) {
                const currentDate = allReports[currentIndex].date;
                document.getElementById('timeline-current').textContent = 
                    new Date(currentDate).toLocaleDateString('en-US', { 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric' 
                    });

                // Update progress bar
                const progress = (currentIndex / allReports.length) * 100;
                document.getElementById('timeline-progress').style.width = progress + '%';

                checkEventLabels(currentDate);
            } else {
                document.getElementById('timeline-current').textContent = 'Timeline Complete';
                document.getElementById('timeline-progress').style.width = '100%';
            }
        }

        function checkEventLabels(currentDate) {
            const date = new Date(currentDate);

            // Show COVID-19 label when it starts (Dec 2019)
            if (!eventLabels.covid && date >= new Date('2019-12-01')) {
                showEventLabel('COVID-19 Pandemic', 'covid', '#ff4444');
            }

            // Show Ukraine label when it starts (Feb 2022)
            if (!eventLabels.ukraine && date >= new Date('2022-02-24')) {
                showEventLabel('Ukraine Conflict', 'ukraine', '#ff8800');
            }

            // Check if we've passed the last COVID-19 report
            if (eventLabels.covid) {
                const remainingCovid = allReports.slice(currentIndex).some(r => r.event === 'COVID-19');
                if (!remainingCovid) {
                    eventLabels.covid.remove();
                    eventLabels.covid = null;
                }
            }

            // Check if we've passed the last Ukraine report
            if (eventLabels.ukraine) {
                const remainingUkraine = allReports.slice(currentIndex).some(r => r.event === 'Ukraine Conflict');
                if (!remainingUkraine) {
                    eventLabels.ukraine.remove();
                    eventLabels.ukraine = null;
                }
            }
        }

        function showEventLabel(text, id, color) {
            const label = document.createElement('div');
            label.className = 'event-label';
            label.textContent = text;
            label.style.background = color;
            label.style.left = (id === 'covid' ? '50%' : '30%');
            label.style.top = '50%';
            label.style.transform = 'translate(-50%, -50%)';
            document.body.appendChild(label);
            eventLabels[id] = label;

            // Label will be removed when no more reports of this type remain
            // No automatic timeout needed
        }

        function animateStep() {
            if (currentIndex >= allReports.length) {
                pause();
                return;
            }

            const currentDate = allReports[currentIndex].date;
            while (currentIndex < allReports.length && allReports[currentIndex].date === currentDate) {
                const report = allReports[currentIndex];
                visiblePoints.push(report);
                
                const marker = createMarker(report, true); // true = show ring animation
                markersMap.set(currentIndex, marker);
                
                currentIndex++;
            }

            updateTimeline();
            updateStats();
        }

        function play() {
            if (isPlaying) return;
            isPlaying = true;
            document.getElementById('playPause').textContent = '⏸ Pause';

            animationInterval = setInterval(() => {
                animateStep();
            }, 100 / speed);
        }

        function pause() {
            isPlaying = false;
            document.getElementById('playPause').textContent = '▶ Play';
            if (animationInterval) {
                clearInterval(animationInterval);
                animationInterval = null;
            }
        }

        function restart() {
            pause();
            currentIndex = 0;
            visiblePoints = [];
            
            // Remove all markers
            markersMap.forEach(marker => marker.remove());
            markersMap.clear();
            
            // Clear active rings
            activeRings = [];
            updateRings();
            
            updateTimeline();
            updateStats();

            if (eventLabels.covid) eventLabels.covid.remove();
            if (eventLabels.ukraine) eventLabels.ukraine.remove();
            eventLabels = { covid: null, ukraine: null };
        }

        function seekToPosition(progressPercent) {
            pause();
            
            // Calculate target index based on progress
            const targetIndex = Math.floor((progressPercent / 100) * allReports.length);
            
            // Clear existing data
            visiblePoints = [];
            markersMap.forEach(marker => marker.remove());
            markersMap.clear();
            activeRings = [];
            updateRings();
            
            // Rebuild up to target index WITHOUT ring animations
            currentIndex = 0;
            while (currentIndex < targetIndex && currentIndex < allReports.length) {
                const report = allReports[currentIndex];
                visiblePoints.push(report);
                const marker = createMarker(report, false); // false = no ring animation
                markersMap.set(currentIndex, marker);
                currentIndex++;
            }
            
            updateTimeline();
            updateStats();
            
            // Reset event labels
            if (eventLabels.covid) {
                eventLabels.covid.remove();
                eventLabels.covid = null;
            }
            if (eventLabels.ukraine) {
                eventLabels.ukraine.remove();
                eventLabels.ukraine = null;
            }
            
            // Check for event labels at current position
            if (currentIndex < allReports.length) {
                checkEventLabels(allReports[currentIndex].date);
            }
        }

        // Load data
        fetch('field_reports.json')
            .then(response => response.json())
            .then(data => {
                allReports = data;
                console.log(`Loaded ${allReports.length} reports`);
                updateTimeline();
            })
            .catch(error => {
                console.error('Error loading data:', error);
                document.getElementById('timeline-current').textContent = 'Error loading data';
            });

        // Event listeners
        document.getElementById('playPause').addEventListener('click', () => {
            if (isPlaying) {
                pause();
            } else {
                play();
            }
        });

        document.getElementById('restart').addEventListener('click', restart);

        document.getElementById('speedSlider').addEventListener('input', (e) => {
            speed = parseInt(e.target.value);
            document.getElementById('speedLabel').textContent = speed + 'x';

            if (isPlaying) {
                pause();
                play();
            }
        });

        // Handle window resize
        window.addEventListener('resize', () => {
            map.resize();
        });

        // Zoom controls
        document.getElementById('zoomIn').addEventListener('click', () => {
            map.zoomIn();
        });

        document.getElementById('zoomOut').addEventListener('click', () => {
            map.zoomOut();
        });

        // Timeline scrubbing
        const timelineBar = document.getElementById('timeline-bar');
        let isDraggingTimeline = false;

        function handleTimelineInteraction(e) {
            const rect = timelineBar.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const percent = (x / rect.width) * 100;
            const clampedPercent = Math.max(0, Math.min(100, percent));
            seekToPosition(clampedPercent);
        }

        timelineBar.addEventListener('mousedown', (e) => {
            isDraggingTimeline = true;
            handleTimelineInteraction(e);
        });

        document.addEventListener('mousemove', (e) => {
            if (isDraggingTimeline) {
                handleTimelineInteraction(e);
            }
        });

        document.addEventListener('mouseup', () => {
            isDraggingTimeline = false;
        });

        timelineBar.addEventListener('click', (e) => {
            handleTimelineInteraction(e);
        });
    </script>
</body>
</html>
